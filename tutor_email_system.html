<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¯¼å¸ˆå¥—ç£é‚®ä»¶ç³»ç»Ÿ</title>
    <!-- å¼•å…¥EmailJSåº“ç”¨äºé‚®ä»¶å‘é€ -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- å¼•å…¥ PDF.js ç”¨äºåœ¨æµè§ˆå™¨ä¸­è§£æç®€å†PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
      (function() {
        try {
          const pdfjsLib = window['pdfjs-dist/build/pdf'];
          if (pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
          }
        } catch (e) {
          console.warn('PDF.js åˆå§‹åŒ–å¤±è´¥:', e);
        }
      })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-input {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            border: 2px dashed #4facfe;
            border-radius: 8px;
            text-align: center;
            background: #f8f9ff;
            color: #4facfe;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-input:hover .file-input-label {
            background: #4facfe;
            color: white;
        }

        .tutor-entry {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }

        .tutor-entry h3 {
            color: #4facfe;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            font-size: 18px;
            padding: 15px 40px;
            margin-top: 20px;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        .required {
            color: #ff4757;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ™ºèƒ½å¯¼å¸ˆå¥—ç£é‚®ä»¶ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½ç”Ÿæˆä¸ªæ€§åŒ–å¥—ç£é‚®ä»¶ï¼ŒåŠ©åŠ›å­¦æœ¯ç”³è¯·ä¹‹è·¯</p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-top: 15px; border-radius: 8px; font-size: 0.9em;">
                 <strong>ğŸ“§ ä½¿ç”¨è¯´æ˜ï¼š</strong>æœ¬ç³»ç»Ÿä½¿ç”¨Node.jsåç«¯æœåŠ¡å‘é€é‚®ä»¶ã€‚è¯·ç¡®ä¿ï¼š<br>
                 1. å·²å¯åŠ¨åç«¯æœåŠ¡å™¨ (node email_server.js)<br>
                 2. ä½¿ç”¨QQé‚®ç®±æˆæƒç è€Œéç™»å½•å¯†ç <br>
                 3. åœ¨QQé‚®ç®±è®¾ç½®ä¸­å¼€å¯SMTPæœåŠ¡
             </div>
        </div>

        <div class="main-content">
            <form id="emailForm">
                <!-- ç”¨æˆ·ä¿¡æ¯é…ç½® -->
                <div class="section">
                    <h2>ğŸ“§ é‚®ç®±é…ç½®</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="senderEmail">å‘ä»¶é‚®ç®± <span class="required">*</span></label>
                            <input type="email" id="senderEmail" name="senderEmail" required placeholder="your.email@example.com">
                        </div>
                        <div class="form-group">
                            <label for="senderPassword">é‚®ç®±å¯†ç /æˆæƒç  <span class="required">*</span></label>
                            <input type="password" id="senderPassword" name="senderPassword" required placeholder="é‚®ç®±å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç ">
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="smtpServer">SMTPæœåŠ¡å™¨</label>
                            <input type="text" id="smtpServer" name="smtpServer" placeholder="smtp.gmail.com (è‡ªåŠ¨æ£€æµ‹)">
                        </div>
                        <div class="form-group">
                            <label for="smtpPort">SMTPç«¯å£</label>
                            <input type="number" id="smtpPort" name="smtpPort" placeholder="587 (è‡ªåŠ¨æ£€æµ‹)">
                        </div>
                    </div>
                </div>

                <!-- LLMé…ç½® -->
                <div class="section">
                    <h2>ğŸ¤– LLMé…ç½®</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="llmBaseUrl">LLM Base URL <span class="required">*</span></label>
                            <input type="url" id="llmBaseUrl" name="llmBaseUrl" required placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group">
                            <label for="llmApiKey">API Key <span class="required">*</span></label>
                            <input type="password" id="llmApiKey" name="llmApiKey" required placeholder="sk-...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="llmModel">æ¨¡å‹åç§°</label>
                        <input type="text" id="llmModel" name="llmModel" placeholder="gpt-3.5-turbo">
                    </div>
                </div>

                <!-- ç”³è¯·è€…ä¿¡æ¯ -->
                <div class="section">
                    <h2>ğŸ‘¤ ç”³è¯·è€…ä¿¡æ¯</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="applicantName">å§“å <span class="required">*</span></label>
                            <input type="text" id="applicantName" name="applicantName" required placeholder="å¼ ä¸‰">
                        </div>
                        <div class="form-group">
                            <label for="applicantSchool">å­¦æ ¡ <span class="required">*</span></label>
                            <input type="text" id="applicantSchool" name="applicantSchool" required placeholder="æŸæŸå¤§å­¦">
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="applicantCollege">å­¦é™¢</label>
                            <input type="text" id="applicantCollege" name="applicantCollege" placeholder="è®¡ç®—æœºå­¦é™¢">
                        </div>
                        <div class="form-group">
                            <label for="applicantMajor">ä¸“ä¸š</label>
                            <input type="text" id="applicantMajor" name="applicantMajor" placeholder="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
                        </div>
                    </div>
                </div>                <div class="grid">
                    <div class="form-group">
                        <label for="enrollYear">å…¥å­¦å¹´ä»½ <span class="required">*</span></label>
                        <input type="number" id="enrollYear" name="enrollYear" required placeholder="2021" min="1990" max="2100" step="1">
                    </div>
                    <div></div>
                </div>

                <!-- ç”³è¯·ä¿¡æ¯ -->
                <div class="section">
                    <h2>ğŸ“ ç”³è¯·ä¿¡æ¯</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="applicationType">ç”³è¯·ç›®çš„ <span class="required">*</span></label>
                            <select id="applicationType" name="applicationType" required>
                                <option value="">è¯·é€‰æ‹©ç”³è¯·ç›®çš„</option>
                                <option value="ä¿ç ”">ä¿ç ”</option>
                                <option value="å®ä¹ ">å®ä¹ </option>
                                <option value="è®¿é—®å­¦ç”Ÿ">è®¿é—®å­¦ç”Ÿ</option>
                                <option value="åšå£«ç”³è¯·">åšå£«ç”³è¯·</option>
                                <option value="ç¡•å£«ç”³è¯·">ç¡•å£«ç”³è¯·</option>
                                <option value="åšå£«å">åšå£«å</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resumeFile">ç®€å†PDF <span class="required">*</span></label>
                            <div class="file-input">
                                <input type="file" id="resumeFile" name="resumeFile" accept=".pdf" required>
                                <label for="resumeFile" class="file-input-label">
                                    ğŸ“„ ç‚¹å‡»ä¸Šä¼ ç®€å†PDFæ–‡ä»¶
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="transcriptFile">æˆç»©å•PDFï¼ˆå¯é€‰ï¼‰</label>
                            <div class="file-input">
                                <input type="file" id="transcriptFile" name="transcriptFile" accept=".pdf">
                                <label for="transcriptFile" class="file-input-label">
                                    ğŸ“„ ç‚¹å‡»ä¸Šä¼ æˆç»©å•PDFæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="additionalPdfs">é™„åŠ PDFï¼ˆå¤šé€‰ï¼Œå¯é€‰ï¼‰</label>
                            <div class="file-input">
                                <input type="file" id="additionalPdfs" name="additionalPdfs" accept=".pdf" multiple>
                                <label for="additionalPdfs" class="file-input-label">
                                    ğŸ“ é€‰æ‹©è¦ä¸€å¹¶å‘é€çš„å…¶ä»–PDFï¼ˆä»…æ–‡ä»¶åä¼šè¿›å…¥æç¤ºè¯ï¼‰
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="emailStyle">é‚®ä»¶è¯­è¨€é£æ ¼æç¤ºè¯ <span class="required">*</span> 
                            <span class="tooltip">â„¹ï¸
                                <span class="tooltiptext">æè¿°ä½ å¸Œæœ›ç”Ÿæˆçš„é‚®ä»¶é£æ ¼ï¼Œå¦‚ï¼šæ­£å¼ã€å­¦æœ¯ã€å‹å¥½ç­‰</span>
                            </span>
                        </label>
                        <textarea id="emailStyle" name="emailStyle" required placeholder="è¯·æè¿°ä½ å¸Œæœ›çš„é‚®ä»¶è¯­è¨€é£æ ¼ï¼Œä¾‹å¦‚ï¼šè¯·ç”¨æ­£å¼è€Œä¸å¤±äº²å’Œçš„å­¦æœ¯è¯­è°ƒæ’°å†™ï¼Œé¿å…è¿‡äºAIåŒ–çš„è¡¨è¾¾ï¼Œä½“ç°çœŸè¯šå’Œä¸“ä¸šæ€§..."></textarea>
                    </div>
                </div>

                <!-- å¯¼å¸ˆä¿¡æ¯ -->
                <div class="section">
                    <h2>ğŸ‘¨â€ğŸ« å¯¼å¸ˆä¿¡æ¯</h2>
                    <div id="tutorList">
                        <div class="tutor-entry">
                            <h3>å¯¼å¸ˆ 1</h3>
                            <div class="form-group">
                                <label>å¯¼å¸ˆé‚®ç®± <span class="required">*</span></label>
                                <input type="email" name="tutorEmail[]" required placeholder="professor@university.edu">
                            </div>
                            <div class="form-group">
                                <label>å¯¼å¸ˆå§“å</label>
                                <input type="text" name="tutorName[]" placeholder="æ•™æˆå§“å">
                            </div>
                            <div class="form-group">
                                <label>ä¸ªäººä¸»é¡µç½‘å€</label>
                                <input type="url" name="tutorWebsite[]" placeholder="https://university.edu/~professor">
                            </div>
                            <div class="form-group">
                                <label>ä¸ªäººä»‹ç»æ–‡æœ¬</label>
                                <textarea name="tutorBio[]" placeholder="å¯¼å¸ˆçš„ç ”ç©¶æ–¹å‘ã€å­¦æœ¯èƒŒæ™¯ç­‰ä¿¡æ¯..."></textarea>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="removeTutor(this)" style="display: none;">åˆ é™¤å¯¼å¸ˆ</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addTutor()">â• æ·»åŠ å¯¼å¸ˆ</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('batchUpload').click()">ğŸ“ æ‰¹é‡ä¸Šä¼ </button>
                    <input type="file" id="batchUpload" accept=".csv,.json" style="display: none;" onchange="handleBatchUpload(this)">
                </div>

                <!-- å‘é€æŒ‰é’® -->
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-success">ğŸš€ ç”Ÿæˆå¹¶å‘é€é‚®ä»¶</button>
                </div>

                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 10px;">å‡†å¤‡ä¸­...</div>
                </div>

                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>

    <script>
        let tutorCount = 1;

        // æ·»åŠ å¯¼å¸ˆ
        function addTutor() {
            tutorCount++;
            const tutorList = document.getElementById('tutorList');
            const newTutor = document.createElement('div');
            newTutor.className = 'tutor-entry';
            newTutor.innerHTML = `
                <h3>å¯¼å¸ˆ ${tutorCount}</h3>
                <div class="form-group">
                    <label>å¯¼å¸ˆé‚®ç®± <span class="required">*</span></label>
                    <input type="email" name="tutorEmail[]" required placeholder="professor@university.edu">
                </div>
                <div class="form-group">
                    <label>å¯¼å¸ˆå§“å</label>
                    <input type="text" name="tutorName[]" placeholder="æ•™æˆå§“å">
                </div>
                <div class="form-group">
                    <label>ä¸ªäººä¸»é¡µç½‘å€</label>
                    <input type="url" name="tutorWebsite[]" placeholder="https://university.edu/~professor">
                </div>
                <div class="form-group">
                    <label>ä¸ªäººä»‹ç»æ–‡æœ¬</label>
                    <textarea name="tutorBio[]" placeholder="å¯¼å¸ˆçš„ç ”ç©¶æ–¹å‘ã€å­¦æœ¯èƒŒæ™¯ç­‰ä¿¡æ¯..."></textarea>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeTutor(this)">åˆ é™¤å¯¼å¸ˆ</button>
            `;
            tutorList.appendChild(newTutor);
            updateDeleteButtons();
        }

        // åˆ é™¤å¯¼å¸ˆ
        function removeTutor(button) {
            button.parentElement.remove();
            updateTutorNumbers();
            updateDeleteButtons();
        }

        // æ›´æ–°å¯¼å¸ˆç¼–å·
        function updateTutorNumbers() {
            const tutors = document.querySelectorAll('.tutor-entry h3');
            tutors.forEach((h3, index) => {
                h3.textContent = `å¯¼å¸ˆ ${index + 1}`;
            });
            tutorCount = tutors.length;
        }

        // æ›´æ–°åˆ é™¤æŒ‰é’®æ˜¾ç¤º
        function updateDeleteButtons() {
            const deleteButtons = document.querySelectorAll('.tutor-entry .btn-danger');
            deleteButtons.forEach(button => {
                button.style.display = deleteButtons.length > 1 ? 'inline-block' : 'none';
            });
        }

        // å¤„ç†æ‰¹é‡ä¸Šä¼ 
        function handleBatchUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    }

                    // æ¸…ç©ºç°æœ‰å¯¼å¸ˆåˆ—è¡¨
                    document.getElementById('tutorList').innerHTML = '';
                    tutorCount = 0;

                    // æ·»åŠ æ‰¹é‡å¯¼å¸ˆ
                    data.forEach(tutor => {
                        addTutorFromData(tutor);
                    });

                    showStatus('æ‰¹é‡å¯¼å¸ˆä¿¡æ¯ä¸Šä¼ æˆåŠŸï¼', 'success');
                } catch (error) {
                    showStatus('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ä»æ•°æ®æ·»åŠ å¯¼å¸ˆ
        function addTutorFromData(tutorData) {
            tutorCount++;
            const tutorList = document.getElementById('tutorList');
            const newTutor = document.createElement('div');
            newTutor.className = 'tutor-entry';
            newTutor.innerHTML = `
                <h3>å¯¼å¸ˆ ${tutorCount}</h3>
                <div class="form-group">
                    <label>å¯¼å¸ˆé‚®ç®± <span class="required">*</span></label>
                    <input type="email" name="tutorEmail[]" required placeholder="professor@university.edu" value="${tutorData.email || ''}">
                </div>
                <div class="form-group">
                    <label>å¯¼å¸ˆå§“å</label>
                    <input type="text" name="tutorName[]" placeholder="æ•™æˆå§“å" value="${tutorData.name || ''}">
                </div>
                <div class="form-group">
                    <label>ä¸ªäººä¸»é¡µç½‘å€</label>
                    <input type="url" name="tutorWebsite[]" placeholder="https://university.edu/~professor" value="${tutorData.website || ''}">
                </div>
                <div class="form-group">
                    <label>ä¸ªäººä»‹ç»æ–‡æœ¬</label>
                    <textarea name="tutorBio[]" placeholder="å¯¼å¸ˆçš„ç ”ç©¶æ–¹å‘ã€å­¦æœ¯èƒŒæ™¯ç­‰ä¿¡æ¯...">${tutorData.bio || ''}</textarea>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeTutor(this)">åˆ é™¤å¯¼å¸ˆ</button>
            `;
            tutorList.appendChild(newTutor);
            updateDeleteButtons();
        }

        // è§£æCSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || '';
                    });
                    data.push(obj);
                }
            }
            return data;
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // ä½¿ç”¨ PDF.js è§£æä¸Šä¼ çš„ç®€å†PDFä¸ºçº¯æ–‡æœ¬
        async function extractResumeText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                if (!pdfjsLib) throw new Error('PDF.js æœªåŠ è½½');

                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    fullText += strings.join(' ') + '\n';
                }
                // è§„èŒƒåŒ–ç©ºç™½ï¼Œé¿å…è¿‡é•¿æç¤ºè¯
                return fullText.replace(/\s+/g, ' ').trim();
            } catch (err) {
                console.warn('ç®€å†è§£æå¤±è´¥:', err);
                return '';
            }
        }

        // è‡ªåŠ¨æ£€æµ‹SMTPè®¾ç½®
        function detectSMTPSettings(email) {
            const domain = email.split('@')[1];
            const smtpSettings = {
                'gmail.com': { server: 'smtp.gmail.com', port: 587 },
                'outlook.com': { server: 'smtp-mail.outlook.com', port: 587 },
                'hotmail.com': { server: 'smtp-mail.outlook.com', port: 587 },
                'yahoo.com': { server: 'smtp.mail.yahoo.com', port: 587 },
                '163.com': { server: 'smtp.163.com', port: 587 },
                '126.com': { server: 'smtp.126.com', port: 587 },
                'qq.com': { server: 'smtp.qq.com', port: 587 }
            };

            if (smtpSettings[domain]) {
                document.getElementById('smtpServer').value = smtpSettings[domain].server;
                document.getElementById('smtpPort').value = smtpSettings[domain].port;
            }
        }

        // é‚®ç®±è¾“å…¥æ—¶è‡ªåŠ¨æ£€æµ‹SMTP
        document.getElementById('senderEmail').addEventListener('blur', function() {
            if (this.value) {
                detectSMTPSettings(this.value);
            }
        });

        // æ–‡ä»¶ä¸Šä¼ æ˜¾ç¤º
        document.getElementById('resumeFile').addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (this.files.length > 0) {
                label.textContent = `âœ… ${this.files[0].name}`;
                label.style.background = '#d4edda';
                label.style.color = '#155724';
            }
        });
        // æˆç»©å•ä¸Šä¼ æ˜¾ç¤º
        document.getElementById('transcriptFile').addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (this.files.length > 0) {
                label.textContent = `âœ… ${this.files[0].name}`;
                label.style.background = '#d4edda';
                label.style.color = '#155724';
            } else {
                label.textContent = 'ğŸ“„ ç‚¹å‡»ä¸Šä¼ æˆç»©å•PDFæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰';
                label.style.background = '';
                label.style.color = '';
            }
        });
        // é™„åŠ PDFä¸Šä¼ æ˜¾ç¤º
        document.getElementById('additionalPdfs').addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (this.files.length > 0) {
                label.textContent = `âœ… å·²é€‰æ‹© ${this.files.length} ä¸ªPDFé™„ä»¶`;
                label.style.background = '#d4edda';
                label.style.color = '#155724';
            } else {
                label.textContent = 'ğŸ“ é€‰æ‹©è¦ä¸€å¹¶å‘é€çš„å…¶ä»–PDFï¼ˆä»…æ–‡ä»¶åä¼šè¿›å…¥æç¤ºè¯ï¼‰';
                label.style.background = '';
                label.style.color = '';
            }
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, 'å‡†å¤‡å‘é€é‚®ä»¶...');

            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = new FormData(this);
                const tutors = collectTutorData();
                
                if (tutors.length === 0) {
                    throw new Error('è¯·è‡³å°‘æ·»åŠ ä¸€ä½å¯¼å¸ˆä¿¡æ¯');
                }

                // éªŒè¯æ¯ä¸ªå¯¼å¸ˆè‡³å°‘æœ‰é‚®ç®±å’Œï¼ˆä¸»é¡µæˆ–ä»‹ç»ï¼‰
                for (let tutor of tutors) {
                    if (!tutor.email) {
                        throw new Error('æ‰€æœ‰å¯¼å¸ˆéƒ½å¿…é¡»æä¾›é‚®ç®±åœ°å€');
                    }
                    if (!tutor.website && !tutor.bio) {
                        throw new Error('æ¯ä½å¯¼å¸ˆå¿…é¡»æä¾›ä¸ªäººä¸»é¡µç½‘å€æˆ–ä¸ªäººä»‹ç»æ–‡æœ¬');
                    }
                }

                // æ”¶é›†ç”³è¯·è€…åŸºæœ¬ä¿¡æ¯ï¼ˆä¾›æç¤ºè¯ä¸å‘ä»¶äººåç§°ä½¿ç”¨ï¼‰
                const applicantInfo = {
                    name: (formData.get('applicantName') || '').trim(),
                    school: (formData.get('applicantSchool') || '').trim(),
                    college: (formData.get('applicantCollege') || '').trim(),
                    major: (formData.get('applicantMajor') || '').trim(),
                    enrollYear: (formData.get('enrollYear') || '').trim()
                };

                // ä¸¥æ ¼ä¸»é¢˜æ ¼å¼éœ€è¦å§“åã€å­¦æ ¡ä¸å…¥å­¦å¹´ä»½
                if (!applicantInfo.name || !applicantInfo.school || !applicantInfo.enrollYear) {
                    throw new Error('è¯·å¡«å†™å§“åã€å­¦æ ¡å’Œå…¥å­¦å¹´ä»½ï¼ˆå››ä½å¹´ä»½ï¼‰ï¼Œç”¨äºç”Ÿæˆä¸¥æ ¼ä¸»é¢˜');
                }

                // è§£æä¸Šä¼ çš„ç®€å†PDFæ–‡æœ¬ï¼Œå¹¶é™åˆ¶è¾“å…¥é•¿åº¦
                updateProgress(10, 'æ­£åœ¨è§£æç®€å†PDF...');
                const resumeFileInput = document.getElementById('resumeFile');
                const resumeFile = resumeFileInput && resumeFileInput.files ? resumeFileInput.files[0] : null;
                let resumeText = '';
                if (resumeFile) {
                    resumeText = await extractResumeText(resumeFile);
                }
                const resumeTextLimited = (resumeText || '').slice(0, 4000); // é¿å…æç¤ºè¯è¿‡é•¿

                // è§£ææˆç»©å•PDFæ–‡æœ¬ï¼Œå¹¶é™åˆ¶è¾“å…¥é•¿åº¦ï¼ˆå¯é€‰ï¼‰
                updateProgress(15, 'æ­£åœ¨è§£ææˆç»©å•PDF...');
                const transcriptInput = document.getElementById('transcriptFile');
                const transcriptFile = transcriptInput && transcriptInput.files ? transcriptInput.files[0] : null;
                let transcriptText = '';
                if (transcriptFile) {
                    transcriptText = await extractResumeText(transcriptFile);
                }
                const transcriptTextLimited = (transcriptText || '').slice(0, 4000);

                // æ”¶é›†é™„åŠ PDFçš„æ–‡ä»¶åï¼ˆä»…æ–‡ä»¶åè¿›å…¥æç¤ºè¯ï¼‰
                const additionalInput = document.getElementById('additionalPdfs');
                const additionalFiles = additionalInput && additionalInput.files ? Array.from(additionalInput.files) : [];
                const additionalPdfNames = additionalFiles.map(f => f.name);

                updateProgress(20, 'æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–é‚®ä»¶...');

                // ä¸ºæ¯ä¸ªå¯¼å¸ˆç”Ÿæˆé‚®ä»¶
                for (let i = 0; i < tutors.length; i++) {
                    const tutor = tutors[i];
                    updateProgress(20 + (i / tutors.length) * 60, `æ­£åœ¨ä¸º ${tutor.name || tutor.email} ç”Ÿæˆé‚®ä»¶...`);
                    
                    // è·å–å¯¼å¸ˆä¿¡æ¯
                    let tutorInfo = tutor.bio || '';
                    if (tutor.website) {
                        try {
                            tutorInfo += await fetchWebsiteContent(tutor.website);
                        } catch (error) {
                            console.warn('æ— æ³•è·å–ç½‘é¡µå†…å®¹:', error);
                        }
                    }

                    // è°ƒç”¨LLMç”Ÿæˆé‚®ä»¶ï¼ˆåŠ å…¥ç®€å†ã€æˆç»©å•è§£ææ–‡æœ¬å’Œé™„åŠ PDFæ–‡ä»¶åï¼‰
                    const emailContent = await generateEmail({
                        tutorInfo: tutorInfo,
                        tutorName: tutor.name,
                        applicationType: formData.get('applicationType'),
                        emailStyle: formData.get('emailStyle'),
                        llmBaseUrl: formData.get('llmBaseUrl'),
                        llmApiKey: formData.get('llmApiKey'),
                        llmModel: formData.get('llmModel') || 'gpt-3.5-turbo',
                        resumeText: resumeTextLimited,
                        transcriptText: transcriptTextLimited,
                        additionalPdfNames: additionalPdfNames,
                        applicant: applicantInfo
                    });

                    // å‘é€é‚®ä»¶
                    // å‘é€é‚®ä»¶ï¼ˆå¼ºåˆ¶ä½¿ç”¨è§„èŒƒä¸»é¢˜ï¼šç±»å‹ï¼šå¹´ä»½ï¼ˆå…¥å­¦æ—¶é—´ï¼‰- å§“å - å­¦æ ¡ï¼‰
                    const typeMap = { 'è®¿é—®å­¦ç”Ÿ': 'è®¿é—®', 'ä¿ç ”': 'ä¿ç ”', 'å®ä¹ ': 'å®ä¹ ' };
                    const appTypeRaw = formData.get('applicationType');
                    const typeText = typeMap[appTypeRaw] || appTypeRaw;
                    const subjectStrict = `${typeText}ï¼š${applicantInfo.enrollYear}ï¼ˆå…¥å­¦æ—¶é—´ï¼‰- ${applicantInfo.name} - ${applicantInfo.school}`;
                    
                    // å‘é€é‚®ä»¶
                    await sendEmail({
                        to: tutor.email,
                        subject: subjectStrict,
                        body: emailContent.body,
                        senderEmail: formData.get('senderEmail'),
                        senderPassword: formData.get('senderPassword'),
                        smtpServer: formData.get('smtpServer'),
                        smtpPort: formData.get('smtpPort'),
                        resumeFile: formData.get('resumeFile'),
                        transcriptFile: formData.get('transcriptFile'),
                        additionalPdfs: additionalFiles,
                        senderName: applicantInfo.name || 'ç”³è¯·è€…'
                    });
                }

                updateProgress(100, 'æ‰€æœ‰é‚®ä»¶å‘é€å®Œæˆï¼');
                showStatus(`æˆåŠŸå‘ ${tutors.length} ä½å¯¼å¸ˆå‘é€äº†ä¸ªæ€§åŒ–å¥—ç£é‚®ä»¶ï¼`, 'success');
                
            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
                showStatus('å‘é€å¤±è´¥: ' + error.message, 'error');
                updateProgress(0, 'å‘é€å¤±è´¥');
            }

            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
            }, 3000);
        });

        // æ”¶é›†å¯¼å¸ˆæ•°æ®
        function collectTutorData() {
            const tutors = [];
            const tutorEntries = document.querySelectorAll('.tutor-entry');
            
            tutorEntries.forEach(entry => {
                const email = entry.querySelector('input[name="tutorEmail[]"]').value;
                const name = entry.querySelector('input[name="tutorName[]"]').value;
                const website = entry.querySelector('input[name="tutorWebsite[]"]').value;
                const bio = entry.querySelector('textarea[name="tutorBio[]"]').value;
                
                if (email) {
                    tutors.push({ email, name, website, bio });
                }
            });
            
            return tutors;
        }

        // è·å–ç½‘é¡µå†…å®¹ï¼ˆé€šè¿‡åç«¯ä»£ç†ï¼‰
        async function fetchWebsiteContent(url) {
            try {
                const response = await fetch(`http://localhost:3000/api/fetch-website?url=${encodeURIComponent(url)}`);
                const result = await response.json();
                
                if (result.success) {
                    return result.content;
                } else {
                    console.warn('æ— æ³•è·å–ç½‘é¡µå†…å®¹:', result.message);
                    return '';
                }
            } catch (error) {
                console.warn('æ— æ³•è·å–ç½‘é¡µå†…å®¹ï¼Œå°†ä½¿ç”¨æä¾›çš„ä¸ªäººä»‹ç»');
                return '';
            }
        }

        // ç”Ÿæˆé‚®ä»¶å†…å®¹
        async function generateEmail(params) {
            const prompt = `
è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€å°ä¸“ä¸šã€ä¸ªæ€§åŒ–ä¸”é«˜åº¦åŒ¹é…çš„å­¦æœ¯å¥—ç£é‚®ä»¶ï¼š

ã€å¯¼å¸ˆä¿¡æ¯ã€‘\n${params.tutorInfo}
ã€å¯¼å¸ˆå§“åã€‘\n${params.tutorName || 'æ•™æˆ'}
ã€ç”³è¯·ç›®çš„ã€‘\n${params.applicationType}
ã€è¯­è¨€é£æ ¼è¦æ±‚ã€‘\n${params.emailStyle}
ã€ç”³è¯·è€…åŸºæœ¬ä¿¡æ¯ï¼ˆç»“æ„åŒ–ï¼‰ã€‘\nå§“åï¼š${params.applicant?.name || ''}ï¼›å­¦æ ¡ï¼š${params.applicant?.school || ''}ï¼›å­¦é™¢ï¼š${params.applicant?.college || ''}ï¼›ä¸“ä¸šï¼š${params.applicant?.major || ''}
ã€ç”³è¯·è€…ç®€å†ï¼ˆå·²è§£ææ–‡æœ¬ï¼‰ã€‘\n${params.resumeText || 'ï¼ˆæœªæä¾›ï¼‰'}
ã€ç”³è¯·è€…æˆç»©å•ï¼ˆå·²è§£ææ–‡æœ¬ï¼‰ã€‘\n${params.transcriptText || 'ï¼ˆæœªæä¾›ï¼‰'}
ã€é™„åŠ PDFï¼ˆä»…æ–‡ä»¶åï¼‰ã€‘\n${(params.additionalPdfNames || []).join('ï¼Œ') || 'ï¼ˆæ— ï¼‰'}

è¯·ä¸¥æ ¼ç»“åˆç”³è¯·è€…ç®€å†ä¸å¯¼å¸ˆç ”ç©¶æ–¹å‘è¿›è¡Œå®šåˆ¶åŒ–å†™ä½œï¼Œè¦æ±‚ï¼š
1. ä¸»é¢˜ç®€æ´æ˜äº†ï¼Œèƒ½ä½“ç°ä¸å¯¼å¸ˆç ”ç©¶çš„å¥‘åˆç‚¹ï¼›
2. æ­£æ–‡éœ€å…ˆå±•ç¤ºå¯¹å¯¼å¸ˆç ”ç©¶çš„å…·ä½“ç†è§£ï¼ˆå¼•ç”¨å…¶ç ”ç©¶æ–¹å‘/è®ºæ–‡/é¡¹ç›®ä¸­çš„å…³é”®ä¿¡æ¯ï¼‰ï¼Œå†ç²¾å‡†åŒ¹é…ç”³è¯·è€…ç®€å†/æˆç»©å•ä¸­çš„ç»å†/æˆæœ/æŠ€èƒ½ï¼›
3. æ˜ç¡®è¡¨è¾¾ç”³è¯·æ„å‘ã€æ‹Ÿè´¡çŒ®ç‚¹ã€å¯å¼€å±•çš„åˆä½œæ–¹å‘ä¸æ—¶é—´å®‰æ’ï¼›
4. ç”¨è¯ä¸“ä¸šå¾—ä½“ã€è‡ªç„¶çœŸè¯šï¼Œé¿å…AIè…”ã€å¥—è¯ä¸ç©ºæ³›å¤¸å¼ ï¼›
5. ä¿¡æ¯å¿…é¡»çœŸå®å‡†ç¡®ï¼Œä¸å¾—æé€ ç»å†ä¸æˆæœï¼›
6. è¾“å‡ºå¿…é¡»ä¸ºJSONæ ¼å¼ï¼Œä»…åŒ…å« subject ä¸ body ä¸¤ä¸ªå­—æ®µï¼›
7. æ­£æ–‡ä¸ºçº¯æ–‡æœ¬ï¼ˆä¸ä½¿ç”¨markdownï¼‰ï¼Œåˆ†ä¸º2-4æ®µï¼Œæ®µè½é—´ç©ºä¸€è¡Œä¸”é¡¶æ ¼ä¹¦å†™ã€‚`;

            try {
                const response = await fetch(`${params.llmBaseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${params.llmApiKey}`
                    },
                    body: JSON.stringify({
                        model: params.llmModel,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`LLM APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    return JSON.parse(content);
                } catch {
                    // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå›é€€ä¸ºé»˜è®¤ä¸»é¢˜å¹¶ç›´æ¥ä½¿ç”¨æ­£æ–‡
                    return {
                        subject: `å…³äº${params.applicationType}ç”³è¯·çš„å’¨è¯¢`,
                        body: content
                    };
                }
            } catch (error) {
                throw new Error(`é‚®ä»¶ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }

        // å‘é€é‚®ä»¶ï¼ˆé€šè¿‡Node.jsåç«¯ï¼‰
        async function sendEmail(params) {
            try {
                // åˆ›å»ºFormDataå¯¹è±¡
                const formData = new FormData();
                formData.append('to', params.to);
                formData.append('subject', params.subject);
                formData.append('body', params.body);
                formData.append('senderEmail', params.senderEmail);
                formData.append('senderPassword', params.senderPassword);
                formData.append('smtpServer', params.smtpServer);
                formData.append('smtpPort', params.smtpPort);
                formData.append('senderName', params.senderName || '');
                
                // å¦‚æœæœ‰ç®€å†æ–‡ä»¶ï¼Œæ·»åŠ 
                if (params.resumeFile) {
                    formData.append('resume', params.resumeFile);
                }
                // å¦‚æœæœ‰æˆç»©å•æ–‡ä»¶ï¼Œæ·»åŠ 
                if (params.transcriptFile) {
                    formData.append('transcript', params.transcriptFile);
                }
                // é™„åŠ PDFï¼ˆå¤šä¸ªï¼‰
                if (params.additionalPdfs && params.additionalPdfs.length) {
                    params.additionalPdfs.forEach(file => {
                        formData.append('attachments', file);
                    });
                }

                // è°ƒç”¨åç«¯APIå‘é€é‚®ä»¶
                const response = await fetch('http://localhost:3000/api/send-email', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('é‚®ä»¶å‘é€æˆåŠŸ:', params.to);
                    return { success: true, message: 'é‚®ä»¶å‘é€æˆåŠŸ' };
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('é‚®ä»¶å‘é€é”™è¯¯:', error);
                throw new Error(`é‚®ä»¶å‘é€å¤±è´¥: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDeleteButtons();
            
            // æ·»åŠ æç¤ºä¿¡æ¯
            showStatus('ç³»ç»Ÿå·²å°±ç»ªï¼Œè¯·å¡«å†™ç›¸å…³ä¿¡æ¯åç‚¹å‡»å‘é€', 'info');
        });
    </script>
</body>
</html>